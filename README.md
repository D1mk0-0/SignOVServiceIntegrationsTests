# SignOVServiceIntegrationsTests

SignOVService - это NuGet-пакет для выполнения криптографических операций используя криптопровадер [КриптоПро CSP](https://www.cryptopro.ru/products/csp) или [VipNet CSP](https://infotecs.ru/products/vipnet-csp/), а также сервис подписания.

## Тесты интеграционные

Тест осуществляет отправку PATCH-запросов в сервис подписания и проверяет, соответствует ли ответ XSD-схеме, а так же представлены ли элементы подписания и соответствуют ли их значения регулярному выражению. Так же отправляет некорректные и невалидные данные и проверяет описание характера ошибки в ответе.

### Запуск тестов

В Windows:

```shell
cd integrations-tests
python -m venv venv
venv\Scripts\activate.ps1
pip install -r requirements.txt
$Env:BASE_API_URL = "10.10.0.164:8080"
$Env:BASIC_AUTH_USER = "root"
$Env:BASIC_AUTH_PASSWORD = "password"
$Env:THUMBPRINT = "3cdbd85fba5b22724ed03136429248e114b8026e"
pytest
```

В Linux:

```shell
cd integrations-tests
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
export BASE_API_URL=10.10.0.164:8086
export BASIC_AUTH_USER=root
export BASIC_AUTH_PASSWORD=password
export THUMBPRINT=3cdbd85fba5b22724ed03136429248e114b8026e
pytest
```

где:

* `BASE_API_URL` - Endpoint сервиса подписания
* `BASIC_AUTH_USER` - Логин для basic-аутентификации
* `BASIC_AUTH_PASSWORD` - Пароль для basic-аутентификации
* `THUMBPRINT` - Отпечаток сертификата, что загружен в сам сервис подписания (пароль не требуется)

Агрегированные результаты будут выведены в консоль.

## Тест-план

**1.** Ответ xml соответствует контракту:

1.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где:

1.2. Значение "thumbprint" = корректный отпечаток сертификата

1.3. Значение "xml" = тут подключается параметризация:

* AckRequest.xml
* GetRequestRequest.xml
* GetResponseRequest.xml
* SendRequestRequest.xml
* SendResponseRequest.xml

1.4. Значение "needSignAttachments" = true

1.5. Значение "mr" = (так же подключена параметризация: 0, 1, 2)

1.6. Упадет, если статус-код ответа не равен 200

1.7. Упадет, если в ответе нет элемента "SignatureValue"

1.8. Упадет, если значение элемента "SignatureValue" в ответе не равно регулярному выражению

1.9. Упадет, если в ответе нет элемента "X509Certificate" (или "BinarySecurityToken", если MR не вавен 3)

1.10. Упадет, если значение элемента "X509Certificate" (или "BinarySecurityToken", если MR не вавен 3) в ответе не равно регулярному выражению

1.11. Упадет, если в ответе нет XML-документа равного XML-схеме (теги и их значения должны соответствовать установленным в шаблоне значениям)

**2.** Ответ xml с вложениями соответствует контракту

2.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где:

2.2. Значение "thumbprint" = корректный отпечаток сертификата

2.3. Значение "xml" = тут подключается параметризация:

* AckRequest.xml
* GetRequestRequestSendAttachCONTENT.xml
* GetResponseRequestAttachCONTENT.xml
* SendRequestRequestAttachCONTENT.xml
* SendResponseRequestAttachCONTENT.xml
* GetRequestRequestSendAttachFTP.xml
* GetResponseRequestAttachFTP.xml
* SendRequestRequestAttachFTP.xml
* SendResponseRequestAttachFTP.xml

2.4. Значение "needSignAttachments" = (так же подключена параметризация: true, false)

2.5. Значение "mr" = (так же подключена параметризация: 0, 1, 2)

2.6. Упадет, если статус-код ответа не равен 200

2.7. Упадет, если в ответе нет XML-документа равного XML-схеме (теги и их значения должны соответствовать установленным в шаблоне значениям)

2.8. Упадет, если в ответе нет элемента "SignatureValue"

2.9. Упадет, если значение элемента "SignatureValue" в ответе не равно регулярному выражению

2.10. Упадет, если в ответе нет элемента "X509Certificate" (или "BinarySecurityToken", если MR не вавен 3)

2.11. Упадет, если значение элемента "X509Certificate" (или "BinarySecurityToken", если MR не вавен 3) в ответе не равно регулярному выражению

2.12. Если "needSignAttachments": false:

* Упадет, если в ответе ЕСТЬ элемент "SignaturePKCS7"

2.13. Если "needSignAttachments": true:

* Упадет, если в ответе НЕТ элемента "SignaturePKCS7"

**3.** Ответ data соответствует контракту

3.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "data": "string"
   }
~~~

где:

3.2. Значение "thumbprint" = корректный отпечаток сертификата

3.3. Значение "data" = так же подключена параметризация:

* загружает файлы, конвертированные в base64 разных размеров:
* 100кб
* 1мб
* 5мб

3.4. Упадет, если статус-код ответа не равен 200

3.5. Упадет, если в ответе нет подстроки "cryptopro"

**4.** Ответ XML авторизация не пройдена при отсутствии заголовка basic auth

4.1. Использует данные для авторизации

4.2. Отправляет PATCH запрос XML с валидными данными, но без заголовка basic auth

4.3. Упадет, если статус код ответа не равен 401 и нет подстроки в ответе про авторизацию

**5.** Ответ XML авторизация не пройдена при некорректном логине и пароле

5.1. Использует данные для авторизации: тут подключена параметризация: 

* корректный логин - некорректный пароль
* некорректный логин - корректный пароль
* некорректный логин - некорректный пароль
* корректный логин - корректный пароль (но в верхнем регистре)

5.2. Отправляет PATCH запрос XML с валидными данными

5.3. Упадет, если статус код ответа не равен 401 и нет подстроки в ответе про авторизацию

**6.** Ответ data авторизация не пройдена при отсутствии заголовка basic auth

6.1. Использует данные для авторизации

6.2. Отправляет PATCH запрос data с валидными данными, но без заголовка basic auth

6.3. Упадет, если статус код ответа не равен 401 и нет подстроки в ответе про авторизацию

**7.** Ответ data авторизация не пройдена при некорректном логине и пароле

7.1. Использует данные для авторизации: тут подключена параметризация: 

* корректный логин - некорректный пароль
* некорректный логин - корректный пароль
* некорректный логин - некорректный пароль
* корректный логин - корректный пароль (но в верхнем регистре)

7.2. Отпрвляет PATCH запрос data с валидными данными

7.3. Упадет, если статус код ответа не равен 401 и нет подстроки в ответе про авторизацию

**8.** Ответ XML содержит ошибку дискриптора

8.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где все значения корректные, за исключением "thumbprint"

8.2. Упадет, если статус код ответа не равен 500 и нет подстроки в ответе про дескриптора

**9.** Ответ data содержит ошибку подписи данных

9.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "data": "string"
   }
~~~

где все значения корректные, за исключением "thumbprint"

9.2. Упадет, если статус код ответа не равен 500 и нет подстроки в ответе про подписи данных

**10.** Ответ XML содержит ошибку парсинга XML

10.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где все значения корректные, за исключением "xml"

10.2. Упадет, если статус код ответа не равен 500 и нет подстроки в ответе про парсинг XML содержимого

**11.** ответ XML содержит ошибку параметра SignXmlDto dto

11.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где все значения корректные, за исключением "needSignAttachments"

11.2. Упадет, если статус код ответа не равен 400 и нет подстроки в ответе про параметр SignXmlDto dto

**12.** ответ XML содержит ошибку параметра версия МР

12.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "xml": "string",
     "needSignAttachments": true,
     "mr": 0
   }
~~~

где все значения корректные, за исключением "mr"

12.2. Упадет, если статус код ответа не равен 500 и нет подстроки в ответе про параметр версия МР

**13.** ответ data содержит ошибку not a valid Base-64

13.1. отправляет PATCH-запрос с телом: 

~~~ json
   {
     "thumbprint": "string",
     "data": "string"
   }
~~~

где все значения корректные, за исключением "data"

13.2. Упадет, если статус код ответа не равен 500 и нет подстроки в ответе про not a valid Base-64